# GitHub Actions CI/CD Pipeline Example
# 이 파일은 예시입니다. 실제 사용 시 .github/workflows/deploy.yml로 복사하세요

name: Deploy to EKS

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: fproject-dev-api
  EKS_CLUSTER_NAME: your-cluster-name

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
      
      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
      
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}
      
      - name: Replace placeholders in K8s manifests
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Update image in deployment
          sed -i "s|YOUR_AWS_ACCOUNT_ID.dkr.ecr.us-east-1.amazonaws.com/fproject-dev-api:latest|$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG|g" k8s/deployment.yaml
          
          # Update ConfigMap with actual values
          sed -i "s|REPLACE_WITH_YOUR_RDS_ENDPOINT|${{ secrets.DB_HOST }}|g" k8s/configmap.yaml
          sed -i "s|REPLACE_WITH_YOUR_USER_POOL_ID|${{ secrets.AWS_USER_POOL_ID }}|g" k8s/configmap.yaml
          sed -i "s|REPLACE_WITH_YOUR_CLIENT_ID|${{ secrets.AWS_CLIENT_ID }}|g" k8s/configmap.yaml
          sed -i "s|REPLACE_WITH_YOUR_S3_BUCKET|${{ secrets.S3_BUCKET }}|g" k8s/configmap.yaml
          sed -i "s|https://your-domain.com|${{ secrets.FRONTEND_URL }}|g" k8s/configmap.yaml
      
      - name: Create/Update Kubernetes Secret
        run: |
          kubectl create secret generic fproject-backend-secret \
            --from-literal=DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            --from-literal=GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}" \
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/configmap.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
      
      - name: Wait for deployment to complete
        run: |
          kubectl rollout status deployment/fproject-backend --timeout=5m
      
      - name: Verify deployment
        run: |
          kubectl get pods -l app=fproject-backend
          kubectl get svc fproject-backend

  deploy-lambda:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Install dependencies
        run: |
          pip install psycopg2-binary boto3 -t .
      
      - name: Package Lambda function
        run: |
          zip -r lambda_function.zip lambda_cognito_delete.py psycopg2* boto3*
      
      - name: Deploy Lambda function
        run: |
          aws lambda update-function-code \
            --function-name lambda-cognito-delete \
            --zip-file fileb://lambda_function.zip
      
      - name: Update Lambda environment variables
        run: |
          aws lambda update-function-configuration \
            --function-name lambda-cognito-delete \
            --environment "Variables={
              USER_POOL_ID=${{ secrets.AWS_USER_POOL_ID }},
              DB_HOST=${{ secrets.DB_HOST }},
              DB_NAME=${{ secrets.DB_NAME }},
              DB_USER=${{ secrets.DB_USER }},
              DB_PASSWORD=${{ secrets.DB_PASSWORD }},
              DB_PORT=5432
            }"
      
      - name: Deploy EventBridge warm-up rule
        run: |
          aws cloudformation deploy \
            --template-file eventbridge-warmup.yaml \
            --stack-name lambda-warmup-stack \
            --parameter-overrides \
              LambdaFunctionName=lambda-cognito-delete \
              WarmUpSchedule="rate(5 minutes)" \
            --capabilities CAPABILITY_IAM

# GitHub Secrets 설정 필요:
# - AWS_ACCESS_KEY_ID
# - AWS_SECRET_ACCESS_KEY
# - DB_HOST
# - DB_NAME
# - DB_USER
# - DB_PASSWORD
# - AWS_USER_POOL_ID
# - AWS_CLIENT_ID
# - S3_BUCKET
# - FRONTEND_URL
# - GOOGLE_CLIENT_SECRET
